<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ESP32 BLE Connect</title>
</head>
<body>
  <h1>ESP32 BLE デモ</h1>
  <button id="connectBtn">ESP32に接続</button>
  <p id="status">未接続</p>
  <p>
    <button id="readBtn" disabled>データを読む</button>
    <button id="writeBtn" disabled>データを書き込む</button>
  </p>
  <pre id="log"></pre>

  <script>
    let characteristic;

    async function connectESP32() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['00001234-0000-1000-8000-00805f9b34fb'] }]
        });

        document.getElementById("status").textContent = "接続中...";

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('00001234-0000-1000-8000-00805f9b34fb');
        characteristic = await service.getCharacteristic('00005678-0000-1000-8000-00805f9b34fb');

        document.getElementById("status").textContent = "接続成功 ✅";
        document.getElementById("readBtn").disabled = false;
        document.getElementById("writeBtn").disabled = false;

      } catch (error) {
        document.getElementById("status").textContent = "エラー: " + error;
      }
    }

    async function readData() {
      if (!characteristic) return;
      const value = await characteristic.readValue();
      let decoder = new TextDecoder("utf-8");
      log("受信: " + decoder.decode(value));
    }

    async function writeData() {
      if (!characteristic) return;
      let encoder = new TextEncoder();
      const data = encoder.encode("Hello ESP32!");
      await characteristic.writeValue(data);
      log("送信: Hello ESP32!");
    }

    function log(msg) {
      document.getElementById("log").textContent += msg + "\n";
    }

    document.getElementById("connectBtn").addEventListener("click", connectESP32);
    document.getElementById("readBtn").addEventListener("click", readData);
    document.getElementById("writeBtn").addEventListener("click", writeData);
  </script>
</body>
</html>
